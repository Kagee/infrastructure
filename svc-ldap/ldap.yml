- hosts:
    - ldap_host
  vars:
    docker_service: ldap
  tasks:
    - import_role:
        name: docker-service

    - set_fact:
        private_key: "{{ docker_service__root }}/ldap.key"
        public_key: "{{ docker_service__root }}/ldap.pem"

    - name: "mkdir {{ ldap_db }}"
      become: yes
      file:
        path: "{{ ldap_db }}"
        state: directory

    - name: Create private key (RSA, 4096 bits)
      become: yes
      community.crypto.openssl_privatekey:
        path: "{{ private_key }}"

    - name: Create certificate signing request (CSR) for self-signed certificate
      become: yes
      community.crypto.openssl_csr_pipe:
        privatekey_path: "{{ private_key }}"
        common_name: "{{ ansible_host }}"
      register: csr

    - name: Create self-signed certificate from CSR
      become: yes
      community.crypto.x509_certificate:
        path: "{{ public_key }}"
        csr_content: "{{ csr.csr }}"
        privatekey_path: "{{ private_key }}"
        provider: selfsigned
